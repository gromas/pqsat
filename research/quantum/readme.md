# Теория детонационного решателя (Collider Solver)

## 1. От сложности к структуре

Задача 3-SAT является **NP-полной**, что означает: в худшем случае любой алгоритм будет работать экспоненциальное время. Однако реальные задачи (даже случайные, вроде бенчмарков SATLIB) обладают **скрытой структурой**, которую можно использовать.

Классические CDCL-решатели ищут эту структуру методом проб и ошибок, накапливая конфликтные клаузы. Мы пошли другим путём: попытались **извлечь структуру напрямую из графа переменных**.

## 2. P/Q разложение: первое наблюдение

Пусть $\(F\)$ — исходная 3-КНФ от $\(n\)$ переменных. Построим **граф взаимодействия** $\(G = (V, E)\)$, где:

- $\(V = \{x_1, \dots, x_n\}\)$ — переменные
- $\((x_i, x_j) \in E\)$, если они встречаются в одном клозе

Найдём **вершинное покрытие** $\(P \subset V\)$ этого графа. Тогда:

$$ \[
Q = V \setminus P
\] $$

— **независимое множество** (между переменными из \(Q\) нет прямых рёбер).

**Ключевое свойство:**  
При любом фиксированном назначении переменных из \(P\) формула \(F\) превращается в **2-КНФ** над \(Q\). Это следует из того, что каждый клоз содержит хотя бы одну переменную из \(P\).

## 3. "Шапка" $\(P_3\)$ и двудольный граф

Рассмотрим клозы, в которых **все три литерала принадлежат \(P\)**. Обозначим их множество:

$$
\[
P_3 = \{c \in F \mid \forall l \in c: |l| \in P\}
\]
$$

Если временно удалить эти клозы, оставшаяся часть формулы становится **двудольной**: каждый клоз содержит либо переменные из \(P\) и \(Q\), либо только из \(Q\). Но поскольку \(Q\) — независимое множество, клозов только из \(Q\) существовать не может. Таким образом:

$$
\[
F = P_3 \cup F_{\text{bipart}}
\]
$$

где $\(F_{\text{bipart}}\)$ — двудольная часть.

Получаем структуру:
- $\(P_3\)$ — плотное ядро (сложные связи внутри \(P\))
- $\(F_{\text{bipart}}\)$ — связи между \(P\) и \(Q\)

## 4. Две перспективы: прямая и обратная

Мы заметили, что эту конструкцию можно **перевернуть**:

- Если зафиксировать \(P\), то \(Q\) становится **2-КНФ** (классическое свойство).
- Но если зафиксировать **часть \(Q\)**, то оставшаяся формула (включая $\(P_3\)$ ) может стать **2-КНФ** над \(P\).

Формально: пусть $\(Q' \subset Q\)$ зафиксировано. Тогда:

$$
\[
F|_{Q'} \ \text{может быть 2-КНФ над} \ P \cup (Q \setminus Q')
\]
$$

Это породило идею **цепной реакции**: назначение одной переменной в $\(Q\)$ может упростить $\(P\)$
, что позволит назначить ещё переменные в $\(Q\)$
, и так далее.

## 5. Детонация как направленный процесс

Мы поняли, что такой процесс похож на **детонационную волну**: выбор одной переменной запускает каскад упрощений, который либо приводит к решению, либо гаснет (противоречие).

Так родилась идея **направленного двудольного графа** $\(D = (V, A)\)$
, где:

- Вершины — переменные $\(V = P \cup Q\)$
- Ориентированное ребро $\((u \to v)\)$ означает, что назначение $\(u\)$ влияет на возможные значения $\(v\)$

Детонация распространяется по графу $\(D\)$ по правилам, аналогичным Unit Propagation, но с учётом структурных слоёв.

## 6. Множественные разложения

Оказалось, что можно построить **несколько разных** P/Q-разложений одной и той же формулы $\(F\)$
. Пусть:

$$
\[
\mathcal{R} = \{(P_1, Q_1), (P_2, Q_2), \dots, (P_k, Q_k)\}
\]
$$

— набор различных вершинных покрытий (и соответствующих независимых множеств).

**Важный инсайт:** значения переменных $\(Q_i\)$
, найденные в одном разложении, можно **переносить** в другие разложения, потому что все они описывают одну и ту же булеву функцию $\(F\)$
.

Это дало возможность **перекрёстного обучения** между разными проекциями задачи.

## 7. "Шапка" — это не проблема, а ресурс

Мы долго считали клозы $\(P_3\)$ (чисто $\(P\)$
) "сложной частью", которую нужно отделить. Но потом поняли:

$$
\[
P_3^{(i)} \ \text{в разложении} \ i \ \text{может быть} \ F_{\text{bipart}}^{(j)} \ \text{в разложении} \ j
\]
$$

То есть одна и та же формула может быть представлена как двудольный граф множеством способов, и "шапка" в одном разложении становится двудольной частью в другом.

Это привело к идее **Лего**: у нас есть исходная формула как набор кирпичиков (клозов), из которых мы можем собрать любой нужный нам граф детонации, просто перегруппировывая клозы.

## 8. Экспериментальная проверка

Дальше началась серия экспериментов, которая привела к эволюции решателей:

1. **PQSAT** — первые попытки P/Q разложения
2. **RSM** — макро-узлы и состояния троек
3. **Франкенштейн** — разрезание на части и склейка через AC-3
4. **Solver3/Solver4** — эволюция CDCL с MOMS и Phase Saving
5. **Solver5/Solver6** — CDCL с конфликтным обучением и рестартами
6. **Turbo Collider** — Numba + итеративный поиск

В результате родился решатель, который:

- Использует структурные свойства 3-КНФ (P/Q разложение)
- Применяет детонационный принцип для каскадного упрощения
- Работает быстро и предсказуемо благодаря Numba-компиляции
- Стабильно решает UF150 за секунды, UF200 за минуты, UF250 за 10–15 минут

### Характеристики Turbo Collider:

- **Язык:** Python + Numba (JIT-компиляция)
- **Память:** практически 0 (константная)
- **Ядра:** 1 (но готов к распараллеливанию)
- **Стабильность:** SAT и UNSAT симметричны по времени
- **UF250 (UNSAT):** 776 секунд (13 минут)

## 9. Заключение

Мы не пытались победить NP-полноту — мы научились **использовать структуру**, которая в случайных 3-КНФ (даже в зоне фазового перехода) оказывается достаточно богатой, чтобы направлять поиск.

Детонация — это не перебор, а **распространение волны назначений** по графу, построенному из исходной формулы как из конструктора Лего. P/Q разложение позволяет строить такие графы, а множественные перспективы дают возможность перекрёстного обучения.

В результате даже на чистом Python, с одним ядром и практически нулевым потреблением памяти, удаётся решать задачи с 250 переменными за время, сравнимое с промышленными C++ солверами 10-летней давности.
